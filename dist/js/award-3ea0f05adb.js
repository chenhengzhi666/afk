"use strict";$(function(){var _arguments=arguments,turnplate={restaraunts:[],colors:[],outsideRadius:222,textRadius:165,insideRadius:65,startAngle:0,bRotate:!1},openid="",nickname="",count=0,SHARELINK="",setting={},weightArr=[],getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?unescape(a[2]):a},init=function(){if(mui.showLoading("正在加载..","div"),getQueryString("code")){localStorage.getItem("openid")?(openid=localStorage.getItem("openid"),nickname=localStorage.getItem("nickname")):$.get("./getUserInfo",{code:getQueryString("code")},function(e){openid=e.data.openid,nickname=e.data.nickname,localStorage.openid=openid,localStorage.nickname=nickname});var t=localStorage.getItem("ticket"),n=localStorage.getItem("appid"),r=Date.parse(new Date)/1e3,i=Number(localStorage.getItem("create_time"))+Number(localStorage.getItem("expires_in")),o=nonceStr();$.get("./getAwardsAndSetting",{},function(e){var a=0;$.each(e.result,function(e,t){a+=t.award_probability,weightArr.push(t.award_probability)}),console.log(a),$.each(weightArr,function(e,t){weightArr[e]=t/a}),console.log(weightArr),turnplate.restaraunts=e.result,SHARELINK=e.shareLink,setting=e.setting[0],$(".rule_text").html(setting.game_rule),t&&n&&localStorage.getItem("create_time")&&localStorage.getItem("expires_in")&&r<i?wxShare(n,o,t):$.get("./getTrcket",{},function(e){localStorage.ticket=e.ticket,localStorage.appid=e.appid,localStorage.create_time=Date.parse(new Date)/1e3,localStorage.expires_in=e.expires_in,wxShare(e.appid,o,e.ticket)}),$.get("./getPrize",{},function(e){$.each(e.result,function(e,t){$(".swiper-wrapper").append('<div class="swiper-slide">恭喜 <span style="color: #FBDB00;">'+decodeURI(t.nickname)+'</span> 抽到 <span style="color: #FBDB00;">'+t.award_name+"</span></div>")}),new Swiper(".swiper-container",{autoplay:{disableOnInteraction:!1},speed:700,height:50,direction:"vertical",loop:!0})}),drawRouletteWheel()})}},wxShare=function(e,t,a){wx.config({debug:!1,appId:e,timestamp:(new Date).getSeconds(),nonceStr:t,signature:create_signature(t,a,(new Date).getSeconds(),window.location.href),jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo"]}),wx.ready(function(){var e={imgUrl:setting.share_icon,link:SHARELINK.link,desc:setting.share_desc,title:setting.share_title,success:function(){}};wx.onMenuShareTimeline(e),wx.onMenuShareAppMessage(e),wx.onMenuShareQQ(e),wx.onMenuShareWeibo(e)})},nonceStr=function(){for(var e="",t=0;t<16;t++)e+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".substr(Math.round(10*Math.random()),1);return e},create_signature=function(e,t,a,n){return sha1("jsapi_ticket="+t+"&noncestr="+e+"&timestamp="+a+"&url="+n)},randomInProbability=function randomInProbability(weights){1<_arguments.length&&(weights=[].slice.call(_arguments));var total=void 0,current=0,parts=[],i=0,l=weights.length;for(total=weights.reduce?weights.reduce(function(e,t){return e+t}):eval(weights.join("+"));i<l;i++)current+=weights[i],parts.push("if( p < ",current/total," ) return ",i/l," + n;");return Function("var p = Math.random(), n = Math.random() / "+l+";"+parts.join(""))},drawRouletteWheel=function(){var e=document.getElementById("wheelcanvas");if(e.getContext){var t=Math.PI/(turnplate.restaraunts.length/2),a=e.getContext("2d");a.clearRect(0,0,516,516),a.strokeStyle="#FFBE04",a.font="bold 22px Microsoft YaHei";for(var n=0;n<turnplate.restaraunts.length;n++){var r=turnplate.startAngle+n*t;a.fillStyle=turnplate.restaraunts[n].award_bg_color,a.beginPath(),a.arc(258,258,turnplate.outsideRadius,r,r+t,!1),a.arc(258,258,turnplate.insideRadius,r+t,r,!0),a.stroke(),a.fill(),a.save(),a.fillStyle="#E83800";var i=turnplate.restaraunts[n].award_name;if(a.translate(258+Math.cos(r+t/2)*turnplate.textRadius,258+Math.sin(r+t/2)*turnplate.textRadius),a.rotate(r+t/2+Math.PI/2),0<i.indexOf("\n"))for(var o=i.split("\n"),l=0;l<o.length;l++)a.font="22px Microsoft YaHei",a.fillText(o[l],-a.measureText(o[l]).width/2,30*l);else if(-1==i.indexOf("\n")&&6<i.length)for(var s=(i=i.substring(0,6)+"||"+i.substring(6)).split("||"),c=0;c<s.length;c++)a.fillText(s[c],-a.measureText(s[c]).width/2,30*c);else a.fillText(i,-a.measureText(i).width/2,0);a.restore()}}mui.hideLoading()},rnd=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},dateFomart=function(){var e=new Date,t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString(),r=e.getHours().toString(),i=e.getMinutes().toString(),o=e.getSeconds().toString();return t+"-"+a.padStart(2,0)+"-"+n.padStart(2,0)+" "+r.padStart(2,0)+":"+i.padStart(2,0)+":"+o.padStart(2,0)},rotateFn=function(e,t){t.creat_time=dateFomart(),t.openid=openid,t.nickname=encodeURI(nickname),delete t.id,delete t.award_bg_color,$.get("./prizeProcess",{data:t},function(e){});var a=e*(360/turnplate.restaraunts.length)-360/(2*turnplate.restaraunts.length);a=a<270?270-a:360-a+270,$("#wheelcanvas").stopRotate(),$("#wheelcanvas").rotate({angle:0,animateTo:a+1800,duration:6e3,callback:function(){if(0<=t.award_name.indexOf("谢谢参与"))$(".xxcy_text").html(t.award_name),$("#xxcy-main").fadeIn(),turnplate.bRotate=!turnplate.bRotate;else{$("#zj-main").fadeIn();var e=t.award_name.replace(/[\r\n]/g,"");$("#jiangpin").text(e),turnplate.bRotate=!turnplate.bRotate}}})};init(),$("#tupBtn").click(function(){if(!turnplate.bRotate){if(0==setting.game_state)return $(".xxcy_text").html(setting.game_info),void $("#xxcy-main").fadeIn();mui.showLoading("正在加载..","div"),$.get("./getUserAward",{openid:openid},function(e){if(mui.hideLoading(),e.result.length>=setting.game_max_order){var a=[];$.each(e.result,function(e,t){a.push(t.award_name)}),$(".xxcy_text").html("您好："+decodeURI(e.result[0].nickname)+"，您的抽奖次数已用完，恭喜您获得“"+a.join("，")+"”奖品，请尽快领取！"),$("#xxcy-main").fadeIn()}else{count++,turnplate.bRotate=!turnplate.bRotate;var t=Math.floor(turnplate.restaraunts.length*randomInProbability(weightArr)());0==t&&turnplate.restaraunts.length,console.log(t),rotateFn(t+1,turnplate.restaraunts[t])}})}}),$(".close_zj").click(function(){$("#zj-main").fadeOut()}),$(".close_xxcy").click(function(){$("#xxcy-main").fadeOut()})});